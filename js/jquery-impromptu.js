(function(a){a.prompt=function(f,c){a.prompt.options=a.extend({},a.prompt.defaults,c);a.prompt.currentPrefix=a.prompt.options.prefix;a.prompt.currentStateName="";var g=a(document.body);var h=a(window);a.prompt.options.classes=a.trim(a.prompt.options.classes);if(a.prompt.options.classes!=""){a.prompt.options.classes=" "+a.prompt.options.classes}var e='<div class="'+a.prompt.options.prefix+"box"+a.prompt.options.classes+'">';if(a.prompt.options.useiframe&&(a("object, applet").length>0)){e+='<iframe src="javascript:false;" style="display:block;position:absolute;z-index:-1;" class="'+a.prompt.options.prefix+'fade"></iframe>'}else{e+='<div class="'+a.prompt.options.prefix+'fade"></div>'}e+='<div class="'+a.prompt.options.prefix+'"><div class="'+a.prompt.options.prefix+'container"><div class="';e+=a.prompt.options.prefix+'close">X</div><div class="'+a.prompt.options.prefix+'states"></div>';e+="</div></div></div>";a.prompt.jqib=a(e).appendTo(g);a.prompt.jqi=a.prompt.jqib.children("."+a.prompt.options.prefix);a.prompt.jqif=a.prompt.jqib.children("."+a.prompt.options.prefix+"fade");if(f.constructor==String){f={state0:{title:a.prompt.options.title,html:f,buttons:a.prompt.options.buttons,position:a.prompt.options.position,focus:a.prompt.options.focus,submit:a.prompt.options.submit}}}var b="";a.each(f,function(m,k){k=a.extend({},a.prompt.defaults.state,k);f[m]=k;var j="",l="";if(k.position.arrow!==null){j='<div class="'+a.prompt.options.prefix+"arrow "+a.prompt.options.prefix+"arrow"+k.position.arrow+'"></div>'}if(k.title&&k.title!==""){l='<div class="'+a.prompt.options.prefix+'title">'+k.title+"</div>"}b+='<div id="'+a.prompt.options.prefix+"state_"+m+'" class="'+a.prompt.options.prefix+'state" style="display:none;">'+j+l+'<div class="'+a.prompt.options.prefix+'message">'+k.html+'</div><div class="'+a.prompt.options.prefix+'buttons">';a.each(k.buttons,function(o,n){if(typeof n=="object"){b+="<button ";if(typeof n.classes!=="undefined"){b+='class="'+(a.isArray(n.classes)?n.classes.join(" "):n.classes)+'" '}b+=' name="'+a.prompt.options.prefix+"_"+m+"_button"+n.title.replace(/[^a-z0-9]+/gi,"")+'" id="'+a.prompt.options.prefix+"_"+m+"_button"+n.title.replace(/[^a-z0-9]+/gi,"")+'" value="'+n.value+'">'+n.title+"</button>"}else{b+='<button name="'+a.prompt.options.prefix+"_"+m+"_button"+o+'" id="'+a.prompt.options.prefix+"_"+m+"_button"+o+'" value="'+n+'">'+o+"</button>"}});b+="</div></div>"});a.prompt.states=f;a.prompt.jqi.find("."+a.prompt.options.prefix+"states").html(b).children("."+a.prompt.options.prefix+"state:first").css("display","block");a.prompt.jqi.find("."+a.prompt.options.prefix+"buttons:empty").css("display","none");a.each(f,function(l,k){var j=a.prompt.jqi.find("#"+a.prompt.options.prefix+"state_"+l);if(a.prompt.currentStateName===""){a.prompt.currentStateName=l}j.bind("promptsubmit",k.submit);j.children("."+a.prompt.options.prefix+"buttons").children("button").click(function(){var r=a(this),p=j.children("."+a.prompt.options.prefix+"message"),o=k.buttons[r.text()]||k.buttons[r.html()];if(o==undefined){for(var n in k.buttons){if(k.buttons[n].title==r.text()||k.buttons[n].title==r.html()){o=k.buttons[n].value}}}if(typeof o=="object"){o=o.value}var q={};a.each(a.prompt.jqi.find("."+a.prompt.options.prefix+"states :input").serializeArray(),function(s,t){if(q[t.name]===undefined){q[t.name]=t.value}else{if(typeof q[t.name]==Array||typeof q[t.name]=="object"){q[t.name].push(t.value)}else{q[t.name]=[q[t.name],t.value]}}});var m=new a.Event("promptsubmit");m.stateName=l;m.state=j;j.trigger(m,[o,p,q]);if(!m.isDefaultPrevented()){a.prompt.close(true,o,p,q)}});j.find("."+a.prompt.options.prefix+"buttons button:eq("+k.focus+")").addClass(a.prompt.options.prefix+"defaultbutton")});var d=function(){if(a.prompt.options.persistent){var k=(a.prompt.options.top.toString().indexOf("%")>=0?(h.height()*(parseInt(a.prompt.options.top,10)/100)):parseInt(a.prompt.options.top,10)),j=parseInt(a.prompt.jqi.css("top").replace("px",""),10)-k;a("html,body").animate({scrollTop:j},"fast",function(){var m=0;a.prompt.jqib.addClass(a.prompt.options.prefix+"warning");var l=setInterval(function(){a.prompt.jqib.toggleClass(a.prompt.options.prefix+"warning");if(m++>1){clearInterval(l);a.prompt.jqib.removeClass(a.prompt.options.prefix+"warning")}},100)})}else{a.prompt.close(true)}};var i=function(m){var l=(window.event)?event.keyCode:m.keyCode;if(l==27){d()}if(l==9){var n=a(":input:enabled:visible",a.prompt.jqib);var k=!m.shiftKey&&m.target==n[n.length-1];var j=m.shiftKey&&m.target==n[0];if(k||j){setTimeout(function(){if(!n){return}var o=n[j===true?n.length-1:0];if(o){o.focus()}},10);return false}}};a.prompt.position();a.prompt.style();a.prompt.jqif.click(d);h.resize({animate:false},a.prompt.position);a.prompt.jqi.find("."+a.prompt.options.prefix+"close").click(a.prompt.close);a.prompt.jqib.bind("keydown keypress",i).bind("promptloaded",a.prompt.options.loaded).bind("promptclose",a.prompt.options.close).bind("promptstatechanging",a.prompt.options.statechanging).bind("promptstatechanged",a.prompt.options.statechanged);a.prompt.jqif.fadeIn(a.prompt.options.overlayspeed);a.prompt.jqi[a.prompt.options.show](a.prompt.options.promptspeed,function(){a.prompt.jqib.trigger("promptloaded")});a.prompt.jqi.find("."+a.prompt.options.prefix+"states ."+a.prompt.options.prefix+"state:first ."+a.prompt.options.prefix+"defaultbutton").focus();if(a.prompt.options.timeout>0){setTimeout(a.prompt.close,a.prompt.options.timeout)}return a.prompt.jqib};a.prompt.defaults={prefix:"jqi",classes:"",title:"",buttons:{Ok:true},loaded:function(b){},submit:function(g,c,b,d){},close:function(g,c,b,d){},statechanging:function(b,d,c){},statechanged:function(b,c){},opacity:0.6,zIndex:999,overlayspeed:"slow",promptspeed:"fast",show:"fadeIn",focus:0,useiframe:false,top:"15%",position:{container:null,x:null,y:null,arrow:null,width:null},persistent:true,timeout:0,state:{title:"",html:"",buttons:{Ok:true},focus:0,position:{container:null,x:null,y:null,arrow:null,width:null},submit:function(g,c,b,d){return true}}};a.prompt.currentPrefix=a.prompt.defaults.prefix;a.prompt.currentStateName="";a.prompt.setDefaults=function(b){a.prompt.defaults=a.extend({},a.prompt.defaults,b)};a.prompt.setStateDefaults=function(b){a.prompt.defaults.state=a.extend({},a.prompt.defaults.state,b)};a.prompt.position=function(g){var d=a.fx.off,c=a(window),k=a(document.body).outerHeight(true),b=a(window).height(),l=a(document).height(),j=k>b?k:b,i=parseInt(c.scrollTop(),10)+(a.prompt.options.top.toString().indexOf("%")>=0?(b*(parseInt(a.prompt.options.top,10)/100)):parseInt(a.prompt.options.top,10)),h=a.prompt.states[a.prompt.currentStateName].position;if(g!==undefined&&g.data.animate===false){a.fx.off=true}a.prompt.jqib.css({position:"absolute",height:j,width:"100%",top:0,left:0,right:0,bottom:0});a.prompt.jqif.css({position:"absolute",height:j,width:"100%",top:0,left:0,right:0,bottom:0});if(h&&h.container){var f=a(h.container).offset();if(a.isPlainObject(f)&&f.top!==undefined){a.prompt.jqi.css({position:"absolute"});a.prompt.jqi.animate({top:f.top+h.y,left:f.left+h.x,marginLeft:0,width:(h.width!==undefined)?h.width:null});i=(f.top+h.y)-(a.prompt.options.top.toString().indexOf("%")>=0?(b*(parseInt(a.prompt.options.top,10)/100)):parseInt(a.prompt.options.top,10));a("html,body").animate({scrollTop:i},"slow","swing",function(){})}}else{if(h&&h.width){a.prompt.jqi.css({position:"absolute",left:"50%"});a.prompt.jqi.animate({top:h.y||i,left:h.x||"50%",marginLeft:((h.width/2)*-1),width:h.width})}else{a.prompt.jqi.css({position:"absolute",top:i,left:"50%",marginLeft:((a.prompt.jqi.outerWidth()/2)*-1)})}}if(g!==undefined&&g.data.animate===false){a.fx.off=d}};a.prompt.style=function(){a.prompt.jqif.css({zIndex:a.prompt.options.zIndex,display:"none",opacity:a.prompt.options.opacity});a.prompt.jqi.css({zIndex:a.prompt.options.zIndex+1,display:"none"});a.prompt.jqib.css({zIndex:a.prompt.options.zIndex})};a.prompt.getStateContent=function(b){return a("#"+a.prompt.currentPrefix+"state_"+b)};a.prompt.getCurrentState=function(){return a("."+a.prompt.currentPrefix+"state:visible")};a.prompt.getCurrentStateName=function(){var b=a.prompt.getCurrentState().attr("id");return b.replace(a.prompt.currentPrefix+"state_","")};a.prompt.goToState=function(c,d){var b=new a.Event("promptstatechanging");a.prompt.jqib.trigger(b,[a.prompt.currentStateName,c]);if(!b.isDefaultPrevented()){a.prompt.currentStateName=c;a("."+a.prompt.currentPrefix+"state").slideUp("slow").find("."+a.prompt.currentPrefix+"arrow").fadeOut();a("#"+a.prompt.currentPrefix+"state_"+c).slideDown("slow",function(){var e=a(this);e.find("."+a.prompt.currentPrefix+"defaultbutton").focus();e.find("."+a.prompt.currentPrefix+"arrow").fadeIn("slow");if(typeof d=="function"){a.prompt.jqib.bind("promptstatechanged.tmp",d)}a.prompt.jqib.trigger("promptstatechanged",[c]);if(typeof d=="function"){a.prompt.jqib.unbind("promptstatechanged.tmp")}});a.prompt.position()}};a.prompt.nextState=function(c){var b=a("#"+a.prompt.currentPrefix+"state_"+a.prompt.currentStateName).next();a.prompt.goToState(b.attr("id").replace(a.prompt.currentPrefix+"state_",""),c)};a.prompt.prevState=function(c){var b=a("#"+a.prompt.currentPrefix+"state_"+a.prompt.currentStateName).prev();a.prompt.goToState(b.attr("id").replace(a.prompt.currentPrefix+"state_",""),c)};a.prompt.close=function(d,c,e,b){a.prompt.jqib.fadeOut("fast",function(){if(d){a.prompt.jqib.trigger("promptclose",[c,e,b])}a.prompt.jqib.remove();a("window").unbind("resize",a.prompt.position)})};a.fn.extend({prompt:function(b){if(b==undefined){b={}}if(b.withDataAndEvents==undefined){b.withDataAndEvents=false}a.prompt(a(this).clone(b.withDataAndEvents).html(),b)}})})(jQuery);